name: Option Chain Collector

on:
  schedule:
    # Every 15 minutes, Mon–Fri, 04:00–10:00 UTC = 09:30–15:30 IST
    - cron: "0,15,30,45 4-10 * * 1-5"

  # Allow manual trigger from GitHub Actions UI for testing
  workflow_dispatch:

jobs:
  collect:
    runs-on: ubuntu-latest
    timeout-minutes: 5        # Kill if it hangs

    defaults:
      run:
        working-directory: backend/render

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: backend/render/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run collector
        env:
          SUPABASE_URL:          ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY:          ${{ secrets.SUPABASE_KEY }}
          UPSTOX_ACCESS_TOKEN:   ${{ secrets.UPSTOX_ACCESS_TOKEN }}
          COLLECT_INTERVAL_MINS: "15"
          FILTER_STRIKES_RADIUS: "20"
        run: python cron_job.py
